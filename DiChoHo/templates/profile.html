{% extends 'base.html' %}
{% load static %}
{% block title %}Profile{% endblock %}

{% block menu_home_class %}active{% endblock %}
{% block page_css %}
<link rel="stylesheet" href="{% static './css/profile.css' %}" />
{% endblock %}
{% block content %}

<div
  class="hero-wrap hero-bread"
  style="background-image: url('/static/images/bg_1.jpg')"
>
  <div class="container">
    <div
      class="
        row
        no-gutters
        slider-text
        align-items-center
        justify-content-center
      "
    >
      <div class="col-md-9 ftco-animate text-center">
        <h1 class="mb-0 bread">Thông tin người dùng</h1>
      </div>
    </div>
  </div>
</div>
<div class="row gutters-sm mt-5">
  <div class="col-md-4 d-none d-md-block">
    <div class="card">
      <div class="card-body">
        <nav class="nav flex-column nav-pills nav-gap-y-1">
          <a href="#profile" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="feather feather-user mr-2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>Hồ sơ người dùng
          </a>
          <a href="#security" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="feather feather-shield mr-2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>Cài đặt bảo mật
          </a>
          <a href="#information_order" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="feather feather-credit-card mr-2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>Lịch sử mua hàng
          </a>
        </nav>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card">
      <div class="card-header border-bottom mb-3 d-flex d-md-none">
        <ul class="nav nav-tabs card-header-tabs nav-gap-x-1" role="tablist">
          <li class="nav-item">
            <a href="#profile" data-toggle="tab" class="nav-link has-icon active"><svg
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-user">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg></a>
          </li>
          <li class="nav-item">
            <a href="#security" data-toggle="tab" class="nav-link has-icon"><svg xmlns="http://www.w3.org/2000/svg"
                width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              </svg></a>
          </li>
          <li class="nav-item">
            <a href="#information_order" data-toggle="tab" class="nav-link has-icon"><svg
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-credit-card">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
              </svg></a>
          </li>
        </ul>
      </div>
      <div class="card-body tab-content">
        <div class="tab-pane active" id="profile">
          <div class="form-group" style="font-size:25px">Thông tin người dùng </div>
          <hr>
          <div class="info">
            <div class="info-left" style="float: left;width: 60%;">
              <div class="info-title">Thông tin cá nhân</div>
              <div class="informational">
                <div class="form-name" style="display:flex;padding-top:30px">
                  <div class="input-label">Họ & tên</div>
                  <div class=" " style="z-index:1 ;flex : 1 1 0%; padding-left:80px;box-sizing: border-box;">
                    <p>{{user.last_name}} {{user.first_name}}</p>
                  </div>
                </div>

                <div class="form-email" style="display:flex;padding-top:30px">
                  <div class="input-label">Email</div>
                  <div class=" " style="z-index:1 ;flex : 1 1 0%; padding-left:102px;box-sizing: border-box;">
                    <p>{{user.email}}</p>
                  </div>
                </div>

                <div class="form-phone" style="display:flex;padding-top:30px">
                  <div class="input-label">Ngày tháng năm sinh</div>
                  <div class=" " style="z-index:1 ;flex : 1 1 0%; padding-left:50px;box-sizing: border-box;">
                    <p>{{profile.birth_date}}</p>
                  </div>
                </div>

                <div class="form-phone" style="display:flex;padding-top:30px">
                  <div class="input-label">Số điện thoại tài khoản</div>
                  <div class=" " style="z-index:1 ;flex : 1 1 0%; padding-left:50px;box-sizing: border-box;">
                    <p>{{profile.phone}}</p>
                  </div>
                </div>

                <div class="form-location" style="display:flex;padding-top:30px">
                  <div class="input-label">Địa chỉ</div>
                  <div class="container px-0">
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                      <div class="col">
                        <a href="{% url "add_address" %}" class="text-reset text-decoration-none" role="button"
                          style="max-width: 540px;">
                          <div class="card mb-3 h-100" style="border: dashed 2px #ccc;">
                            <div class="row g-0 h-100">
                              <div class="col-12" style="min-height:100px">
                                <div class="card-body text-center position-relative mt-5">
                                  <svg style="color:#ccc;" xmlns="http://www.w3.org/2000/svg" width="60" height="60"
                                    fill="currentColor" class="bi bi-plus " viewBox="0 0 16 16">
                                    <path
                                      d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                                  </svg>
                                  <h1 class="h5">Add Address</h1>
                                </div>
                              </div>
                            </div>
                          </div>
                        </a>
                      </div>
                      {% for address in addresses %}
                      <div class="col">
                        <div class="card pb-3 shadow-lg">
                          <div class="card-header bg-white small text-muted">
                            {% if address.default %}
                            Default
                            {% endif %}
                            &nbsp;
                          </div>
                          <div class="card-body small pb-3">
                            <p class="card-text m-0 fw-bold">{{address.full_name}}</p>
                            <p class="card-text m-0">{{address.address_line}}</p>
                            <p class="card-text ">{{address.city}}</p>
                            <p class="card-text m-0">Số điện thoại nhận hàng: {{address.phone}}</p>
                            <div class="pt-5">
                              <a href="{% url 'edit_address' address.id %}" class="text-decoration-none">Edit</a>

                              <a href="{% url 'delete_address' address.id %}" class="text-decoration-none">Delete</a>
                              {% if not address.default %}

                              <a href="{% url 'set_address_default' address.id %}" class="text-decoration-none">Set
                                Default</a>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        </a>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <div class="form-phone" style="display:flex;padding-top:30px">
                  <div class=" "
                    style="z-index:1 ;flex : 1 1 0%;position : relative; padding-left: 50px;box-sizing: border-box;">
                    {% comment %} <button type="submit" class="btn-solve"
                      style="color:white;background-color:#02BE6E;padding: 10px 40px 7px 40px;box-sizing: border-box;">Chỉnh sửa thông tin</button> {% endcomment %}
                    <a role="button" href="{% url 'edit_profile' user.id %}" class="btn btn-primary py-3 px-4">Chỉnh sửa thông tin</a>
                  </div>
                </div>

              </div>
            </div>
            <div class="blockquote" style="border-left:1px solid rgb(235, 235, 240);margin:16px 0px;;"></div>
            <div class="info-right" style="float:right;width: 40%;">
              <div class="image_right">
                <div class="image_right_bottom">
                  <div class="choose_group">
                    <div class="choose_file" style="background-image: url({{profile.profile_pic.url|slice:"10:"}});"></div>
                  </div>
                  {% comment %} <input class="image_file" type="file" accept=".jpg,.jpeg,.png"><button type="button"
                    class="btn btn-light btn--m btn--inline">Chọn ảnh</button> {% endcomment %}
                </div>
              </div>
            </div>
          </div>

        </div>



        <div class="tab-pane" id="security">
          <div class="form-group" style="font-size:25px;" >Đổi mật khẩu</div>
          <h6>Để bảo mật tài khoản vui lòng không chia sẻ mật khẩu cho người khác</h6>
          <hr>
          <div class="block_change_password" style="display:block;margin-top:0em;">

            <form method="post"
              style="padding:16px;border:1px solid rgb(235,235,240);box-sizing:border-box;border-radius:4px;display:block;width: 80%;float:left;">
              {% csrf_token %}
              {{ form }}
              {% comment %} <div class="form-password-current" style="font-size:20px;padding-top:10px;">Mật khẩu hiện
                tại</div>
              <div class="input-password-current"
                style="border:1px solid rgb(235,235,240);box-sizing:border-box;border-radius:4px">
                <input name="oldPassword" type="password" maxlength="50" placeholder="Nhập mật khẩu hiện tại" value=""
                  style="font-size:15px;padding-right:470px;margin:10px 4px" id="typepass">
                <input type="checkbox" onclick="Toggle()">
                <b style="right:0">Hiện</b>
              </div>

              <div class="form-password-new" style="font-size:20px;padding-top:20px">Mật khẩu mới</div>
              <div class="input-password-new"
                style="border:1px solid rgb(235,235,240);box-sizing:border-box;border-radius:4px">
                <input name="newPassword" type="password" maxlength="50" placeholder="Nhập mật khẩu mới" value=""
                  style="font-size:15px;padding-right:470px;margin:10px 4px" id="typepassnew">
                <input type="checkbox" onclick="Toggle1()">
                <b style="right:0">Hiện</b>
              </div>

              <div class="form-confirm-password" style="font-size:20px;padding-top:20px">Nhập lại mật khẩu mới</div>
              <div class="input-confirm-password"
                style="border:1px solid rgb(235,235,240);box-sizing:border-box;border-radius:4px">
                <input name="retypePassword" type="password" maxlength="50" placeholder="Nhập lại mật khẩu mới" value=""
                  style="font-size:15px;padding-right:470px;margin:10px 4px" id="typepassconfirmnew">
                <input type="checkbox" onclick="Toggle2()">
                <b style="right:0">Hiện</b>
              </div> {% endcomment %}
              <div class="btn_finish" style="padding-top:20px;">
                <button type="submit" class="btn btn-primary py-3 px-4" role="button"
                  style="width:30%; font-size:20px">Lưu</button>
              </div>

            </form>

          </div>
        </div>
        <div class="tab-pane" id="information_order">
          <div class="form-group" style="font-size:25px">Thông tin đơn hàng</div>
          <hr>
          <div class="container">
            {% for order in orders %}
            <div class="row g-3">
              <div class="col-12 bg-light p-3 d-flex justify-content-between">
                <div class=" pe-3">
                  Tổng tiền đã trả: <span class="fw-bold">{{ order.total_paid }} VNĐ</span>
                </div>
                <div class="d-flex d-flex-inline">
                  <div class="text-end pe-3">Ngày mua hàng: {{ order.created }}</div>
                </div>
              </div>
              <div class="col-md-7 col-lg-12 p-0">

                {% for item in order.items.all %}
                <div class="card mb-3">
                  <div class="row g-0">
                    <div class=" col-md-10">
                      <div class="card-body p-3">
                        <a class="text-decoration-none" id="{{ item.product.id }}" href="{{ item.product.get_absolute_url }}">
                          <p class="card-text medium">{{item.product.title}}</p>
                        </a>
                        <button class="btn btn-primary jQueryEvaluate" style="width:20%" id="evaluate{{item.product.id}}" type="button" data-toggle="modal" data-target="#guidanhgia">
                        Để lại đánh giá</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
          <hr>
        </div>
        <div class="modal fade" id="guidanhgia" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
          aria-hidden="true">
          <div class="modal-dialog modal-notify modal-warning" role="document">
            <div class="modal-content">
              <div class="modal-header text-center" style="background-color: #02BE6E">
                <h4 class="modal-title white-text w-100 font-weight-bold py-2 text-light" style="margin-left:25px">Để
                  lại đánh giá</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true" class="white-text">&times;</span>
                </button>
              </div>

              <div class="modal-body">
                <div class="md-form mb-5">
                  <label data-error="wrong" data-success="right" for="form3">Nội dung đánh giá</label>
                  <input type="text" id="form3" class="form-control validate">
                </div>

                <div class="md-form">
                  <label data-error="wrong" data-success="right" for="form2">Số sao cho sản phẩm</label>
                  <select class="form-control validate" id="form2">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                </div>
              </div>

              <div class="modal-footer justify-content-center">
                <a type="button" class="btn btn-outline-warning waves-effect text-light submit_evaluation"
                  style="background:#02BE6E; border-radius: 15px" id="sendRating">Gửi đánh giá</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="alert alert-success" role="alert" style="position: fixed; bottom: 0px; left: 25px; display: none;" id="success-alert">
  Đã gửi đánh giá
</div>

<script>
  function Toggle() {
    var temp = document.getElementById("typepass");
    if (temp.type === "password") {
      temp.type = "text";
    } else {
      temp.type = "password";
    }
  }

  function Toggle1() {
    var temp = document.getElementById("typepassnew");
    if (temp.type === "password") {
      temp.type = "text";
    } else {
      temp.type = "password";
    }
  }

  function Toggle2() {
    var temp = document.getElementById("typepassconfirmnew");
    if (temp.type === "password") {
      temp.type = "text";
    } else {
      temp.type = "password";
    }
  }

  $('.submit_evaluation').on('click', function (e) {
    e.preventDefault();
    $('#guidanhgia').modal('toggle');
    return false;
  });

  $(document).ready(function(){
    var prodid = ""
    $(".jQueryEvaluate").on("click",function(e){
      if (e.target !== e.currentTarget) return;
      e.preventDefault();
			var clickElementId = e.target.id;
			if (clickElementId.includes("evaluate"))
      {
        prodid = clickElementId.replace("evaluate","");
      }
    });

    $("#sendRating").on("click",function(event) {
            var contentRating = document.getElementById("form3").value;
            var starRating = parseFloat(document.getElementById("form2").value);
            console.log(contentRating);
            $.ajax({
            type: 'POST',
            url: '{% url "review_add" %}',
            data: {
              productid: prodid,
              star: starRating,
              content: contentRating,
              csrfmiddlewaretoken: "{{csrf_token}}",
              action: 'post'
            },
            success: function (json) {
              document.getElementById("form3").value = "";
              document.getElementById("form2").value = "";
              $("#success-alert").show();
              $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
              $("#success-alert").slideUp(500);
            });
            },
            error: function (xhr, errmsg, err) {}
          });
        })
  });
</script>
<br><br><br>
{% endblock %}